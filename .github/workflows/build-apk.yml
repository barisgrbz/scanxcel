name: Build and Release APK

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Generate localization files
        run: flutter gen-l10n
        
      - name: Build APK
        run: flutter build apk --release
        
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: scanxcel-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          
      - name: Get version from pubspec.yaml
        id: get_version
        run: echo "VERSION=$(grep 'version:' pubspec.yaml | awk '{print $2}' | cut -d'+' -f1)" >> $GITHUB_OUTPUT
        
      - name: Generate release notes
        id: generate_notes
        run: |
          # Son commit mesajƒ±ndan release notlarƒ± olu≈ütur
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_BODY=$(git log -1 --pretty=format:"%b")
          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Commit body'den deƒüi≈üiklik notlarƒ±nƒ± √ßƒ±kar
          CHANGES=""
          if [[ -n "$COMMIT_BODY" ]]; then
            # Emoji'li satƒ±rlarƒ± bul
            CHANGES=$(echo "$COMMIT_BODY" | grep -E "^- [üöÄ‚ú®üîßüêõüì±üé®üîóüõ°Ô∏è‚ö°üéØüìã]" | head -8)
          fi
          
          # Eƒüer deƒüi≈üiklik bulunamazsa commit mesajƒ±ndan √ßƒ±kar
          if [[ -z "$CHANGES" ]]; then
            CHANGES="- üîß $COMMIT_MSG"
          fi
          
          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "DATE=$DATE" >> $GITHUB_OUTPUT
          echo "CHANGES<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        
      - name: Rename APK file
        run: |
          cd build/app/outputs/flutter-apk
          mv app-release.apk scanxcel.apk
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/app/outputs/flutter-apk/scanxcel.apk
          name: Release v${{ steps.get_version.outputs.VERSION }}
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## üöÄ ScanXcel v${{ steps.get_version.outputs.VERSION }}
            
            **Release Date**: ${{ steps.generate_notes.outputs.DATE }}
            
            ### ‚ú® What's New
            ${{ steps.generate_notes.outputs.CHANGES }}
            
            ### üì± APK Download
            - **scanxcel.apk** - Android APK dosyasƒ± (Ready to install)
            - **Size**: ~15MB
            - **Min SDK**: Android 5.0 (API 21+)
            - **Target SDK**: Android 13 (API 33)
            
            ### üìã Installation Guide
            1. **Download** the `scanxcel.apk` file
            2. **Enable** "Install from unknown sources" in Android settings
            3. **Install** the APK file on your device
            4. **Open** ScanXcel and start scanning!
            
            ### üåê Web Version
            üîó **[Try Live Demo](https://barisgrbz.github.io/scanxcel/)** - No installation required!
            
            ### üîÑ Update from Previous Version
            - In-app update notification will appear automatically
            - Or download and install manually from this release
            
            ### üõ†Ô∏è Technical Details
            - **Framework**: Flutter 3.27.0+
            - **Platform**: Android, Web, iOS (coming soon)
            - **Features**: Barcode scanning, Excel export, Multi-language support
            
            ---
            
            üí° **Tip**: Use the web version for quick scanning or download the APK for full mobile experience!
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
